#!/usr/bin/env stack
-- stack --install-ghc runghc --package turtle --package protolude

{-# LANGUAGE OverloadedStrings #-}
{-# LANGUAGE NoImplicitPrelude #-}

import Protolude
import Turtle
import qualified Control.Foldl as L

import Data.Text (words)

type PdfViewer = [Text]
type PID = Text

pdfViewer :: PdfViewer
pdfViewer = ["zathura", "evince", "okular"]


data CommandType
    = Status
    | Save Text
    | Load Text
    | Show

data Command
    = Command
    { verbose :: Bool
    , action :: CommandType
    }

cmdLine :: Parser Command
cmdLine = Command
        <$> (switch "verbose" 'v' "display verbose output")
        <*> ((subcommand "status" "display information about current session" (pure Status))
           <|> fmap Save
                (subcommand "save" "save the current session to the database"
                    (optText "name" 'n' "name of session"))
           <|> fmap Load
                (subcommand "load" "restore a session from the database"
                    (optText "name" 'n' "name of session"))
           <|> (subcommand "show" "show saved sessions" (pure Show))
            )


getPIDs :: PdfViewer -> Shell (Maybe PID)
getPIDs viewers = numbers
  where
    psout   = inproc "ps" ["aux"] empty
    grepped = grep (choice (fmap (contains . text) viewers)) psout
    textl   = fmap (words . lineToText) grepped
    numbers = fmap head textl

getOpenedPdfs :: PID -> Shell Turtle.FilePath
getOpenedPdfs pid = do
    ls ("/proc" </> (fromString $ toS pid) </> "fd")


main :: IO ()
main = do
    com <- options "Epdfphron - the sheppard of your opened pdfs\n(C) 2017 Robin Raymond; licensed under GPL 3" cmdLine
    let vb = verbose com
        ac = action com
    case ac of
        Status -> status (logger vb)
        _      -> echo "Stub. TODO: Implement"


logger :: (Show a, MonadIO m) => Bool -> a -> m ()
logger False _ = return ()
logger True t  = liftIO $ print t

-- TODO: Find out what the type signature here is
status l = do
    pids <- Turtle.fold (getPIDs pdfViewer) L.list
    l pids
